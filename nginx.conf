events {}


http {
   include mime.types;

   # Resolver for dynamic DNS resolution (Docker's internal DNS)
   resolver 127.0.0.11 valid=10s;

   gzip on;
   gzip_vary on;
   gzip_proxied any;
   gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
   gzip_comp_level 6;
   gzip_min_length 1000;


   proxy_cache_path /var/cache/nginx/proxy_cache levels=1:2 keys_zone=ncache:10m inactive=60m max_size=10g; # https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path


   upstream servers {
       server backend:8080;
   }


   server {
       listen 80;


       proxy_set_header Host $host; # https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;


       location /api/ {
           # Use variable to force dynamic DNS resolution
           set $backend_upstream http://backend:8080;
           proxy_pass $backend_upstream;  # No trailing slash - preserves /api prefix
           proxy_no_cache 1;
           proxy_cache_bypass 1;
       }

        location /grafana/ {
            proxy_pass http://grafana:3000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

       location ~ \.(css|js|png|jpeg|jpg|ico|html)$ {
           access_log off;

           # Use variable to force dynamic DNS resolution
           set $frontend_upstream http://frontend:80;
           proxy_pass $frontend_upstream;


           proxy_cache ncache; # https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache
           proxy_cache_valid 200 1d; # https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_valid
           proxy_cache_valid 404 1m;
           add_header X-Proxy-Cache $upstream_cache_status; # https://nginx.org/en/docs/http/ngx_http_headers_module.html#add_header


           expires 1d;
           add_header Cache-Control "public, max-age=86400";
           add_header Pragma "public";
       }


       location = /meilisearch-viewer {
           alias /usr/share/nginx/html/meilisearch-viewer.html;
           default_type text/html;
       }

       # Proxy Meilisearch API to avoid CORS issues
       location /meilisearch-api/ {
           # Use variable to force dynamic DNS resolution
           set $meilisearch_upstream http://meilisearch:7700;
           rewrite ^/meilisearch-api/(.*) /$1 break;
           proxy_pass $meilisearch_upstream;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
           proxy_pass_request_headers on;
           # Allow CORS
           add_header Access-Control-Allow-Origin * always;
           add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
           add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
           
           if ($request_method = OPTIONS) {
               return 204;
           }
       }

       location / {
           # Use variable to force dynamic DNS resolution
           set $frontend_upstream http://frontend:80;
           proxy_pass $frontend_upstream;
       }
   }
}

