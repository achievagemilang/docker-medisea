    events {}

    http {
        include mime.types;
        resolver 127.0.0.11 valid=10s;

        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;
        gzip_comp_level 6;
        gzip_min_length 1000;

        proxy_cache_path /var/cache/nginx/proxy_cache levels=1:2 keys_zone=ncache:10m inactive=60m max_size=10g;

        upstream servers {
            server backend:8080;
        }

        server {
            listen 80;
            server_name digitalent.games.test.shopee.io;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            location /api/ {
                proxy_pass http://backend:8080;
                proxy_no_cache 1;
                proxy_cache_bypass 1;
            }

            location = /meilisearch {
                root /usr/share/nginx/html/;
                try_files /meilisearch-viewer.html =404;
            }

            location /grafana/public/ {
                proxy_pass http://grafana:3000/public/;
            }

            location /grafana/ {
                proxy_pass http://grafana:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # static asset frontend
            location ~ ^/(?!grafana).*\.((css|js|png|jpeg|jpg|ico)$) {
                access_log off;
                proxy_pass http://frontend:80;

                proxy_cache ncache;
                proxy_cache_valid 200 1d;
                proxy_cache_valid 404 1m;
                add_header X-Proxy-Cache $upstream_cache_status;

                expires 1d;
                add_header Cache-Control "public, max-age=86400";
            }

            location /meilisearch-api/ {
                rewrite ^/meilisearch-api/(.*) /$1 break;
                proxy_pass http://meilisearch:7700;

                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;

                proxy_pass_request_headers on;

                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;

                if ($request_method = OPTIONS) {
                    return 204;
                }
            }

            location /vm1/ {
                proxy_pass http://frontend:80/vm1/;
            }
        }
    }
